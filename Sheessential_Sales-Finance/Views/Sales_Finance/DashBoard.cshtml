@{
    ViewData["Title"] = "Dashboard";
}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
    body {
        background-color: #FFFBFD; /* This is the main page background */
        color: #A36A66;
    }

    /* Helper class for chart containers */
    .chart-container {
        /* Common styling for both chart cards */
        background-color: #ffffff;
        padding: 1.5rem;
        border-radius: 1rem; /* rounded-2xl */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-md */
        border: 1px solid #f0f0f0; /* Light border */
    }
</style>

<div class="p-8 min-h-screen">

    <h1 class="text-3xl font-bold mb-6" style="color:#A36A66;">
        Welcome to the Dashboard, @ViewBag.UserName
    </h1>

    <h2 class="text-lg font-semibold mb-4" style="color:#A36A66;">
        Dashboard Overview
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <div class="rounded-2xl shadow-md px-6 py-5 border border-gray-100 flex items-center gap-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-10 w-10 text-[#A36A66]">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625C9.75 8.004 10.254 7.5 10.875 7.5h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0 1 9.75 19.875V8.625ZM16.5 4.125C16.5 3.504 17.004 3 17.625 3h2.25c.621 0 1.125.504 1.125 1.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25A1.125 1.125 0 0 1 16.5 19.875V4.125Z" />
            </svg>

            <div>
                <p class="text-md font-semibold" style="color:#A36A66;">Total Revenue</p>
                <p class="text-sm mt-1" style="color:#A36A66;">₱@ViewBag.Revenue.ToString("N2")</p>
            </div>
        </div>

        <div class="rounded-2xl shadow-md px-6 py-5 border border-gray-100 flex items-center gap-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-10 w-10 text-[#A36A66]">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c.61 0 1.17.255 1.562.686l2.853 3.804A.5.5 0 0 1 21 18.75V19.5a.5.5 0 0 1-.5.5h-15a.5.5 0 0 1-.5-.5v-1.372A.5.5 0 0 1 5.062 17.5l.235-.314M4.5 11.25h15L15 7.5M4.5 11.25l.235-.314m0 0L8.25 5.25M7.5 14.25v-3.75m0 0L8.25 5.25m-3.75 0L4.5 7.5m0 0l3-3m0 0L11.25 7.5" />
            </svg>

            <div>
                <p class="text-md font-semibold" style="color:#A36A66;">Total Expense</p>
                <p class="text-sm mt-1" style="color:#A36A66;">₱@ViewBag.Expense.ToString("N2")</p>
            </div>
        </div>

        <div class="rounded-2xl shadow-md px-6 py-5 border border-gray-100 flex items-center gap-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-10 w-10 text-[#A36A66]">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.375-1.849m-15.375 1.849V5.25A2.25 2.25 0 0 1 4.5 3h15a2.25 2.25 0 0 1 2.25 2.25v10.5A2.25 2.25 0 0 1 19.5 18h-15a2.25 2.25 0 0 1-2.25-2.25m15.375-1.849a2.25 2.25 0 0 0-2.25-2.25H4.5M2.25 18.75h15.375a2.25 2.25 0 0 1-2.25-2.25H4.5a2.25 2.25 0 0 1-2.25-2.25V5.25M2.25 18.75V5.25m18 13.5V5.25m0 13.5a2.25 2.25 0 0 0 2.25-2.25V5.25a2.25 2.25 0 0 0-2.25-2.25H4.5a2.25 2.25 0 0 0-2.25 2.25v10.5a2.25 2.25 0 0 0 2.25 2.25h15.375Z" />
            </svg>

            <div>
                <p class="text-md font-semibold" style="color:#A36A66;">Net Profit</p>
                <p class="text-sm mt-1" style="color:#A36A66;">₱@ViewBag.NetProfit.ToString("N2")</p>
            </div>
        </div>

    </div>
    @* CHARTS *@
    <div class="flex justify-end mb-4">
        <select id="timePeriodSelect" class="block w-48 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" style="color:#A36A66;">
            <option value="year">This Year</option>
            <option value="month">This Month</option>
            <option value="week">This Week</option>
            <option value="alltime">All Time</option>
        </select>
        </select>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">


        <div class="lg:col-span-2 chart-container">
            <h2 class="text-lg font-semibold mb-4" style="color:#A36A66;">Profit Trend %</h2>
            <div class="w-full h-80">
                <canvas id="profitTrendChart"></canvas>
            </div>
        </div>

        <div class="lg:col-span-1 chart-container">
            <h2 class="text-lg font-semibold mb-4" style="color:#A36A66;">Expense Breakdown</h2>
            <div class="w-full h-80 flex items-center justify-center">
                <canvas id="expenseBreakdownChart"></canvas>
            </div>
        </div>

    </div>

    <div class="rounded-2xl shadow-md border border-gray-100 p-6">
        <h2 class="text-xl font-semibold mb-4" style="color:#A36A66;">Recent Activity</h2>

        <div class="divide-y divide-gray-100">
            @if (ViewBag.ActionLogs != null && ((IEnumerable<dynamic>)ViewBag.ActionLogs).Any())
            {
                foreach (var log in (IEnumerable<dynamic>)ViewBag.ActionLogs)
                {
                    <div class="py-3 flex justify-between items-start">

                        <div class="flex flex-col text-sm w-1/4">
                            <p class="font-semibold" style="color:#A36A66;">
                                @log.UserName
                            </p>
                            <p class="text-xs text-gray-500">
                                @log.TimeStamp.ToString("MM/dd/yyyy")
                            </p>
                            <p class="text-xs text-gray-500">
                                @log.TimeStamp.ToString("hh:mm:ss tt")
                            </p>
                        </div>

                        <div class="text-sm w-3/4 pl-4" style="color:#A36A66;">
                            <p>
                                @log.Action.ToLower()d
                                <span class="font-semibold">@log.Entity</span> –
                                @log.Description
                            </p>
                        </div>
                    </div>
                }
            }
            else
            {
                <p class="text-sm italic py-3" style="color:#A36A66;">No recent activity yet.</p>
            }
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Shared Color Variables ---
        const primaryColor = '#A36A66';
        const secondaryColor = '#FFA593';
        const mutedColor = '#f0f0f0';

        // Base colors for charts
        const baseColors = [primaryColor, secondaryColor, '#d3b5b3', '#bfa8a7', '#8a5a57', '#fcd5ce'];

        // Helper function for doughnut chart colors
        const generateDoughnutColors = (count) => {
            let colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(baseColors[i % baseColors.length]);
            }
            return colors;
        };

        // --- Store Chart Instances ---
        let revenueTrendChart; // Renamed
        let expenseBreakdownChart;

        // ----------------------------------------------------------------------------------
        // 1. REVENUE TREND LINE CHART (Initialization)
        // ----------------------------------------------------------------------------------
        const revenueTrendCtx = document.getElementById('profitTrendChart').getContext('2d');
        revenueTrendChart = new Chart(revenueTrendCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [] // Initialize as empty, will be filled by updateCharts()
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', /* ... other options */ },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Amount ($)', color: '#6c757d' },
                        grid: { color: mutedColor, borderColor: mutedColor }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        // ----------------------------------------------------------------------------------
        // 2. EXPENSE BREAKDOWN DOUGHNUT CHART (Initialization)
        // ----------------------------------------------------------------------------------
        // (This section is unchanged from your previous code, but I'm including it for completeness)
        const expenseBreakdownCtx = document.getElementById('expenseBreakdownChart').getContext('2d');
        expenseBreakdownChart = new Chart(expenseBreakdownCtx, {
            type: 'doughnut',
            data: {
                labels: [], // Will be filled
                datasets: [{
                    label: 'Expense Share',
                    data: [], // Will be filled
                    backgroundColor: [], // Will be set dynamically
                    hoverOffset: 8,
                    borderWidth: 1,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { position: 'right', /* ... other options */ },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const value = context.parsed;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return ` ${label}$${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // ----------------------------------------------------------------------------------
        // 3. DATA FETCHING AND CHART UPDATE LOGIC (MODIFIED)
        // ----------------------------------------------------------------------------------
        async function updateCharts(period) {
            try {
                // Use the controller/action path you provided
                const response = await fetch(`/Sales_Finance/GetChartData?period=${period}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();

                // --- Update Revenue Trend Chart (NEW LOGIC) ---
                revenueTrendChart.data.labels = data.revenueTrend.labels;

                // Dynamically build datasets with correct styling
                revenueTrendChart.data.datasets = data.revenueTrend.datasets.map((dataset, index) => {
                    const color = baseColors[index % baseColors.length];
                    return {
                        ...dataset, // This includes Label and Data from the server
                        borderColor: color,
                        backgroundColor: 'rgba(163, 106, 102, 0.1)', // You can make this dynamic too
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false,
                        pointRadius: 4,
                        pointBackgroundColor: color
                    };
                });
                revenueTrendChart.update();

                // --- Update Expense Breakdown Chart (Unchanged) ---
                const expenseLabels = data.expenseBreakdown.labels;
                const expenseData = data.expenseBreakdown.datasets[0].data;

                expenseBreakdownChart.data.labels = expenseLabels;
                expenseBreakdownChart.data.datasets[0].data = expenseData;
                expenseBreakdownChart.data.datasets[0].backgroundColor = generateDoughnutColors(expenseLabels.length);
                expenseBreakdownChart.update();

            } catch (error) {
                console.error('Failed to fetch chart data:', error);
            }
        }

        // ----------------------------------------------------------------------------------
        // 4. EVENT LISTENER (Unchanged)
        // ----------------------------------------------------------------------------------
        const periodSelect = document.getElementById('timePeriodSelect');
        periodSelect.addEventListener('change', (e) => {
            updateCharts(e.target.value);
        });

        // Initial load
        updateCharts(periodSelect.value);

    });
</script>