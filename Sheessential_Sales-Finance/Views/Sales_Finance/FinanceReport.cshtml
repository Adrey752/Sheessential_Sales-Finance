@{
    ViewData["Title"] = "Finance Report";
}

<div class="px-6 py-4">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-xl font-semibold">Reports</h1>
            <p class="text-sm text-gray-500">Finance Report</p>
        </div>

        <!-- Right side dropdown + button -->
        <div class="flex gap-3">
            <select id="periodFilter" class="border border-gray-300 rounded-lg px-3 py-1 text-sm cursor-pointer">
                <option value="week" selected>This Week</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
                <option value="alltime">All time</option>
            </select>

            <button id="generateReport" class="bg-green-500 hover:bg-green-600 text-white text-sm px-4 py-2 rounded-lg">
                Generate Report
            </button>
        </div>
    </div>

    <!-- Top Summary Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">

        <!-- Total Income -->
        <div class="bg-white rounded-xl shadow-lg px-6 py-5">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-full bg-pink-100 flex items-center justify-center">
                    💰
                </div>
                <p class="font-medium text-gray-700">Total Income</p>
            </div>

            <h2 id="cardIncome" class="text-3xl font-bold mt-4">₱0.00</h2>
            <p id="cardIncomeSub" class="text-xs text-gray-400 mt-2">—</p>
        </div>

        <!-- Total Expenses -->
        <div class="bg-white rounded-xl shadow-lg px-6 py-5">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-full bg-pink-100 flex items-center justify-center">
                    🧾
                </div>
                <p class="font-medium text-gray-700">Total Expenses</p>
            </div>

            <h2 id="cardExpenses" class="text-3xl font-bold mt-4">₱0.00</h2>
            <p id="cardExpensesSub" class="text-xs text-gray-400 mt-2">—</p>
        </div>

        <!-- Net Profit -->
        <div class="bg-white rounded-xl shadow-lg px-6 py-5">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-full bg-pink-100 flex items-center justify-center">
                    📈
                </div>
                <p class="font-medium text-gray-700">Net Profit</p>
            </div>

            <h2 id="cardProfit" class="text-3xl font-bold mt-4">₱0.00</h2>
            <p id="cardProfitSub" class="text-xs text-gray-400 mt-2">—</p>
        </div>

        <!-- Net Profit % -->
        <div class="bg-white rounded-xl shadow-lg px-6 py-5">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-full bg-pink-100 flex items-center justify-center">
                    🏦
                </div>
                <p class="font-medium text-gray-700">Net Profit %</p>
            </div>

            <h2 id="cardProfitPct" class="text-3xl font-bold mt-4">0%</h2>
            <p id="cardProfitPctSub" class="text-xs text-gray-400 mt-2">—</p>
        </div>

    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">

        <!-- Bar Chart -->
        <div class="bg-white shadow-lg rounded-2xl p-6 flex flex-col" style="height: 380px;">
            <div class="flex justify-between items-center mb-3">
                <p class="font-semibold text-sm">Revenue vs Expense</p>
            </div>
            <canvas id="financeChart" style="height: 300px;"></canvas>
        </div>

        <!-- Doughnut Chart -->
        <div class="bg-white shadow-lg rounded-2xl p-6 flex flex-col" style="height: 380px;">
            <p class="font-semibold text-sm mb-3">Expense Breakdown</p>
            <div class="flex justify-center items-center flex-1">
                <canvas id="expenseBreakdown" style="height: 290px;"></canvas>
            </div>
        </div>

    </div>

    <!-- Finance Overview Table -->
    <div class="bg-white shadow-md rounded-xl p-5">
        <h2 class="font-semibold text-lg mb-4">Finance Overview</h2>
        <!-- Filter Button (Top Right) -->
        <div class="flex justify-end mb-3 relative">
            <button id="filterToggle"
                    class="flex items-center gap-2 px-4 py-2 border rounded-lg shadow-sm hover:bg-gray-100 transition">
                <span>Filter</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M3 4a1 1 0 011-1h16a1 1 0 011 1l-7 8v7l-4 2v-9L3 4z" />
                </svg>
            </button>

            <!-- Filter Dropdown -->
            <div id="filterMenu"
                 class="hidden absolute right-0 mt-2 bg-white border shadow-lg rounded-lg p-4 w-64 z-50">

                <label class="block text-sm font-medium mb-1">Category</label>
                <select id="filterCategory" class="w-full border rounded-lg px-2 py-1 mb-3">
                    <option value="All">All</option>
                    <option value="Income">Income</option>
                    <option value="Expense">Expense</option>
                </select>

                <label class="block text-sm font-medium mb-1">Sort by Amount</label>
                <select id="filterSort" class="w-full border rounded-lg px-2 py-1 mb-3">
                    <option value="desc">Highest → Lowest</option>
                    <option value="asc">Lowest → Highest</option>
                </select>

                <!-- Department (only visible for Expense) -->
                <label class="block text-sm font-medium mb-1 hidden" id="deptLabel">Department</label>
                <select id="filterDept" class="w-full border rounded-lg px-2 py-1 mb-3 hidden">
                    <option value="All">All departments</option>
                    <option value="Accounting">Accounting</option>
                    <option value="HR">HR</option>
                    <option value="Website">Website</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Inventory">Inventory</option>
                </select>

                <label class="block text-sm font-medium mb-1">Show Rows</label>
                <select id="filterLimit" class="w-full border rounded-lg px-2 py-1 mb-3">
                    <option value="10">Top 10</option>
                    <option value="25">Top 25</option>
                    <option value="50">Top 50</option>
                    <option value="All">Show All</option>
                </select>

                <button id="applyFilter"
                        class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                    Apply
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-[#2D6CDF] text-white text-sm">
                        <th class="py-3 px-4 rounded-l-lg">Reference No.</th>
                        <th class="py-3 px-4">Date</th>
                        <th class="py-3 px-4">Description</th>
                        <th class="py-3 px-4">Type</th>
                        <th class="py-3 px-4">Category</th>
                        <th class="py-3 px-4">Department</th>
                        <th class="py-3 px-4 rounded-r-lg">Amount</th>
                    </tr>
                </thead>

                <tbody id="financeTableBody" class="text-sm text-gray-700">
                    <!-- rows inserted dynamically -->
                </tbody>
            </table>
        </div>
    </div>
</div>



<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const currencyFormatter = amount => {
        return amount.toLocaleString('en-PH', { style: 'currency', currency: 'PHP' });
    }

    let financeChartInstance = null;
    let expenseBreakdownInstance = null;

    const defaultLabels = ["Jan", "Feb", "Mar"];

    function createCharts() {
        const ctxFinance = document.getElementById("financeChart").getContext("2d");
        financeChartInstance = new Chart(ctxFinance, {
            type: 'bar',
            data: {
                labels: defaultLabels,
                datasets: [
                    {
                        label: "Revenue",
                        data: [0, 0, 0],
                        backgroundColor: "#ec4899",
                        borderRadius: 8,
                    },
                    {
                        label: "Expense",
                        data: [0, 0, 0],
                        backgroundColor: "#3b82f6",
                        borderRadius: 8,
                    }
                ]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: { position: "bottom", labels: { boxWidth: 12 } }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        const ctxDough = document.getElementById("expenseBreakdown").getContext("2d");
        expenseBreakdownInstance = new Chart(ctxDough, {
            type: 'doughnut',
            data: {
                labels: ["No data"],
                datasets: [{
                    data: [1],
                    backgroundColor: ["#3b82f6"],
                    cutout: "70%",
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                plugins: { legend: { position: "right", labels: { boxWidth: 10 } } }
            }
        });
    }

    function updateCards(data, periodLabel) {
        document.getElementById("cardIncome").textContent = currencyFormatter(data.totalIncome);
        document.getElementById("cardExpenses").textContent = currencyFormatter(data.totalExpenses);
        document.getElementById("cardProfit").textContent = currencyFormatter(data.netProfit);
        document.getElementById("cardProfitPct").textContent = (data.netProfitPercent ?? 0) + "%";

        const subText = `From ${new Date(data.startDate).toLocaleDateString()} to ${new Date(data.endDate).toLocaleDateString()}`;
        document.getElementById("cardIncomeSub").textContent = subText;
        document.getElementById("cardExpensesSub").textContent = subText;
        document.getElementById("cardProfitSub").textContent = subText;
        document.getElementById("cardProfitPctSub").textContent = periodLabel;
    }

    function updateFinanceChart(labels, revenueData, expenseData) {
        financeChartInstance.data.labels = labels;
        financeChartInstance.data.datasets[0].data = revenueData;
        financeChartInstance.data.datasets[1].data = expenseData;
        financeChartInstance.update();
    }

    function updateBreakdown(labels, data) {
        if (!labels || labels.length === 0) {
            labels = ["No data"];
            data = [1];
        }

        // First two fixed colors (pink & blue), rest auto generated
        const fixedColors = ["#ec4899", "#3b82f6"];

        const dynamicColors = labels.map((_, i) => {
            if (i < fixedColors.length) return fixedColors[i];

            // Generate distinct colors for the rest
            return `hsl(${(i * 60) % 360}, 80%, 65%)`;
        });

        expenseBreakdownInstance.data.labels = labels;
        expenseBreakdownInstance.data.datasets[0].data = data;
        expenseBreakdownInstance.data.datasets[0].backgroundColor = dynamicColors;
        expenseBreakdownInstance.update();
    }

    // Store original rows from last fetch
    let originalRows = [];

    // Replace existing updateTable to store rows
    function updateTable(rows) {
        originalRows = rows;  // store full dataset before filtering

        renderTable(rows);    // draw table
    }

    // separate function that handles rendering only
    function renderTable(rows) {
        const tbody = document.getElementById("financeTableBody");
        tbody.innerHTML = "";

        rows.forEach(r => {
            const date = new Date(r.date).toISOString().split('T')[0];
            tbody.innerHTML += `
                <tr class="border-b">
                    <td class="py-3 px-4">${r.reference}</td>
                    <td class="px-4">${date}</td>
                    <td class="px-4">${r.description}</td>
                    <td class="px-4">${r.type}</td>
                    <td class="px-4">${r.category}</td>
                    <td class="px-4">${r.department}</td>
                    <td class="px-4 font-medium">${currencyFormatter(r.amount)}</td>
                </tr>
            `;
        });
    }


     const filterToggle = document.getElementById("filterToggle");
    const filterMenu = document.getElementById("filterMenu");
    const filterCategory = document.getElementById("filterCategory");
    const filterSort = document.getElementById("filterSort");
    const filterDept = document.getElementById("filterDept");
    const deptLabel = document.getElementById("deptLabel");
    const filterLimit = document.getElementById("filterLimit");   // ✅ NEW
    const applyFilter = document.getElementById("applyFilter");

    // Toggle dropdown visibility
    filterToggle.addEventListener("click", () => {
        filterMenu.classList.toggle("hidden");
    });

    // Show Department dropdown only when Expense is selected
    filterCategory.addEventListener("change", () => {
        if (filterCategory.value === "Expense") {
            filterDept.classList.remove("hidden");
            deptLabel.classList.remove("hidden");
        } else {
            filterDept.classList.add("hidden");
            deptLabel.classList.add("hidden");
        }
    });

    // Apply filter
    applyFilter.addEventListener("click", () => {
        let filtered = [...originalRows];

        // Filter by type/category
        if (filterCategory.value !== "All") {
            filtered = filtered.filter(r => r.type === filterCategory.value);
        }

        // Filter by department (only for Expense)
        if (filterDept.value !== "All" && filterCategory.value === "Expense") {
            filtered = filtered.filter(r => r.department === filterDept.value);
        }

        // Sort ascending/descending by amount
        filtered.sort((a, b) =>
            filterSort.value === "asc"
                ? a.amount - b.amount
                : b.amount - a.amount
        );

        // ✅ NEW: Limit rows (Top N or All)
        if (filterLimit.value !== "All") {
            filtered = filtered.slice(0, parseInt(filterLimit.value));
        }

        renderTable(filtered);
        filterMenu.classList.add("hidden");
    });

    async function loadReport(period) {
        const resp = await fetch(`/Sales_Finance/FinanceReportData?period=${encodeURIComponent(period)}`);
        if (!resp.ok) {
            console.error("Failed to load report data", resp.statusText);
            return;
        }
        const json = await resp.json();

        // normalize response names (server returns e.g. TotalIncome)
        const payload = {
            totalIncome: json.totalIncome ?? json.TotalIncome ?? 0,
            totalExpenses: json.totalExpenses ?? json.TotalExpenses ?? 0,
            netProfit: json.netProfit ?? json.NetProfit ?? 0,
            netProfitPercent: json.netProfitPercent ?? json.NetProfitPercent ?? 0,
            labels: json.labels ?? json.Labels ?? [],
            revenue: json.revenue ?? json.Revenue ?? [],
            expense: json.expense ?? json.Expense ?? [],
            breakdownLabels: json.breakdownLabels ?? json.BreakdownLabels ?? [],
            breakdownData: json.breakdownData ?? json.BreakdownData ?? [],
            rows: json.rows ?? json.Rows ?? [],
            startDate: json.startDateIso ?? json.StartDateIso ?? json.startDate ?? json.StartDate,
            endDate: json.endDateIso ?? json.EndDateIso ?? json.endDate ?? json.EndDate
        };

        const periodLabelMap = {
            week: "Week",
            month: "Month",
            year: "Year",
            alltime: "All time"
        };

        updateCards(payload, periodLabelMap[period] ?? period);
        updateFinanceChart(payload.labels, payload.revenue, payload.expense);
        updateBreakdown(payload.breakdownLabels, payload.breakdownData);
        updateTable(payload.rows);
    }

    // init
    createCharts();
    // default load
    const select = document.getElementById("periodFilter");
    loadReport(select.value);

    // onchange + generate button
    select.addEventListener("change", () => loadReport(select.value));
    document.getElementById("generateReport").addEventListener("click", () => loadReport(select.value));
</script>
